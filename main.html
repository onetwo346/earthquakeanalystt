<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Earthquake Analyst</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/jsLKmRVo5Y8L8O+1o=" crossorigin=""/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Exo 2', sans-serif;
            background: linear-gradient(135deg, #1a1a3d, #2a4066);
            color: #d9e4ff;
            min-height: 100vh;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            width: 100%;
        }
        #logo {
            width: clamp(80px, 20vw, 120px);
            height: auto;
            display: block;
            margin: 0 auto 25px;
            filter: drop-shadow(0 5px 10px rgba(0, 198, 255, 0.5));
        }
        h1 {
            text-align: center;
            font-size: clamp(1.5em, 5vw, 2.5em);
            background: linear-gradient(90deg, #00c6ff, #ff5e62);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }
        p {
            text-align: center;
            font-size: clamp(0.9em, 3vw, 1.2em);
            color: #b3c7ff;
            margin-bottom: 20px;
        }
        #controls {
            margin-bottom: 25px;
            text-align: center;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        button {
            padding: 12px 25px;
            font-size: clamp(0.8em, 2.5vw, 1em);
            font-weight: 700;
            color: #fff;
            background: linear-gradient(45deg, #00c6ff, #ff5e62);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 198, 255, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            white-space: nowrap;
        }
        button:disabled {
            background: #4a5e8c;
            box-shadow: none;
            cursor: not-allowed;
        }
        button:hover:not(:disabled), button:active:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(255, 94, 98, 0.6);
        }
        #earthquakeData, #aiFeedback, #statsView, #earthquakeMap {
            max-width: 850px;
            width: 100%;
            margin: 20px auto;
            padding: 20px;
            background: rgba(42, 64, 102, 0.9);
            border: 2px solid #00c6ff;
            border-radius: 15px;
            overflow-y: auto;
            height: 350px;
            box-shadow: 0 5px 20px rgba(0, 198, 255, 0.3);
        }
        #earthquakeMap {
            height: 350px;
            padding: 0;
            display: none;
            position: relative;
        }
        
        /* Fix for Leaflet map tiles */
        .leaflet-container {
            height: 100%;
            width: 100%;
            border-radius: 15px;
        }
        
        .earthquake-marker {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #earthquakeData h2, #statsView h2, #aiFeedback h2 {
            color: #ff5e62;
            font-size: clamp(1.2em, 4vw, 1.5em);
            margin-top: 0;
        }
        #earthquakeData div, #statsView div {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            margin: 5px 0;
            border-radius: 10px;
        }
        footer {
            text-align: center;
            margin-top: 30px;
            font-size: clamp(0.8em, 2vw, 1em);
            color: #b3c7ff;
        }
        #aiFeedback {
            background: linear-gradient(45deg, rgba(0, 198, 255, 0.2), rgba(255, 94, 98, 0.2));
            border: 2px solid #ff5e62;
            display: none;
        }
        .dangerous {
            color: #ff6b6b;
            font-weight: bold;
        }
        .ai-prediction {
            font-size: clamp(1em, 3vw, 1.3em);
            margin-bottom: 15px;
            color: #d9e4ff;
        }
        .risk-assessment, .safety-measures {
            padding: 15px;
            margin-top: 10px;
            border-radius: 10px;
            background: rgba(255, 94, 98, 0.3);
            color: #fff;
        }
        .safety-measures {
            background: rgba(0, 198, 255, 0.3);
        }
        #statsDatePicker {
            padding: 10px;
            font-size: clamp(0.9em, 2.5vw, 1em);
            background: #2a4066;
            color: #d9e4ff;
            border: 2px solid #00c6ff;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            width: 100%;
            max-width: 200px;
        }
        .leaflet-popup-content-wrapper {
            background: rgba(42, 64, 102, 0.95);
            color: #d9e4ff;
            border-radius: 10px;
        }
        .leaflet-popup-tip {
            background: rgba(42, 64, 102, 0.95);
        }
        
        /* Pulse animation for significant earthquakes */
        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        /* Add more visible pulse animation */
        .pulse-marker {
            animation: pulsate 1.5s ease-in-out infinite;
        }
        
        @keyframes pulsate {
            0% { 
                opacity: 0.6;
                transform: scale(1);
            }
            50% {
                opacity: 0.3;
                transform: scale(1.4);
            }
            100% {
                opacity: 0.6;
                transform: scale(1);
            }
        }
        
        /* Better visibility for map elements */
        .leaflet-marker-icon, .leaflet-marker-shadow {
            filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.7));
        }
        
        /* Custom style for circle markers */
        .leaflet-interactive {
            stroke-width: 2;
            filter: drop-shadow(0 0 5px rgba(0, 198, 255, 0.8));
        }
        
        /* Enhanced AI Insights with better styling */
        .ai-header {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            border-bottom: 1px solid rgba(0, 198, 255, 0.3);
            padding-bottom: 10px;
        }
        
        .ai-icon {
            width: 35px;
            height: 35px;
            min-width: 35px;
            background: linear-gradient(45deg, #00c6ff, #ff5e62);
            border-radius: 50%;
            margin-right: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(0, 198, 255, 0.5);
        }
        
        .ai-icon:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60%;
            height: 60%;
            background: rgba(255, 255, 255, 0.9);
            transform: translate(-50%, -50%);
            clip-path: polygon(0 0, 100% 0, 100% 70%, 50% 100%, 0 70%);
        }
        
        .ai-prediction {
            font-size: clamp(1.1em, 3vw, 1.4em);
            margin-bottom: 20px;
            color: #d9e4ff;
            padding: 15px;
            border-left: 4px solid #ff5e62;
            background: rgba(255, 94, 98, 0.1);
            border-radius: 0 10px 10px 0;
            font-weight: 500;
            letter-spacing: 0.3px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .ai-stats {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .ai-stat-box {
            flex: 1;
            min-width: 130px;
            background: rgba(0, 198, 255, 0.1);
            padding: 15px;
            margin: 0;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(0, 198, 255, 0.2);
        }
        
        .ai-stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 7px 15px rgba(0, 198, 255, 0.3);
        }
        
        .ai-stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #00c6ff;
            margin-bottom: 5px;
        }
        
        .ai-stat-label {
            font-size: 0.9em;
            color: #b3c7ff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .risk-assessment, .safety-measures {
            padding: 15px;
            margin-top: 15px;
            border-radius: 10px;
            background: rgba(255, 94, 98, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 94, 98, 0.2);
        }
        
        .safety-measures {
            background: rgba(0, 198, 255, 0.1);
            border: 1px solid rgba(0, 198, 255, 0.2);
        }
        
        .insight-tab {
            background: rgba(42, 64, 102, 0.7);
            border: none;
            color: #b3c7ff;
            padding: 10px 15px;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            margin-right: 5px;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .insight-tab.active {
            background: rgba(42, 64, 102, 0.9);
            color: #d9e4ff;
            border-bottom: 2px solid #00c6ff;
        }
        
        .insight-content {
            display: none;
            margin-top: 15px;
        }
        
        .insight-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .trend-graph {
            height: 150px;
            width: 100%;
            margin: 10px 0 20px;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            padding-bottom: 25px;
            padding-left: 25px;
        }
        
        .trend-graph-bar {
            flex: 1;
            margin: 0 2px;
            background: linear-gradient(to top, rgba(0, 198, 255, 0.3), rgba(0, 198, 255, 0.8));
            border-radius: 3px 3px 0 0;
            min-height: 5px;
            position: relative;
        }
        
        .trend-graph-bar.danger {
            background: linear-gradient(to top, rgba(255, 94, 98, 0.3), rgba(255, 94, 98, 0.8));
        }
        
        .trend-graph-label {
            position: absolute;
            bottom: -25px;
            font-size: 10px;
            color: #b3c7ff;
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .trend-graph-title {
            margin-bottom: 10px;
            color: #d9e4ff;
            font-size: 0.9em;
            text-align: center;
        }
        
        .trend-axis {
            position: absolute;
            left: -25px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .trend-axis-label {
            font-size: 10px;
            color: #b3c7ff;
        }
        
        .regional-insight {
            background: rgba(42, 64, 102, 0.6);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .regional-insight h3 {
            color: #00c6ff;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .ai-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-right: 5px;
            margin-bottom: 5px;
            background: rgba(0, 198, 255, 0.2);
            color: #d9e4ff;
            border: 1px solid rgba(0, 198, 255, 0.3);
        }
        
        .ai-badge.warning {
            background: rgba(255, 94, 98, 0.2);
            border: 1px solid rgba(255, 94, 98, 0.3);
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 198, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00c6ff;
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-container {
            text-align: center;
            padding: 20px;
        }
        
        /* Responsive improvements for better cross-device compatibility */
        @media (max-width: 768px) {
            body {
                padding: 15px 10px;
            }
            
            #controls {
                display: grid;
                grid-template-columns: 1fr 1fr;
                width: 100%;
                gap: 8px;
            }
            
            button {
                width: 100%;
                padding: 10px 15px;
                font-size: 14px;
                margin: 0;
            }
            
            #earthquakeData, #aiFeedback, #statsView, #earthquakeMap {
                height: 350px;
                margin: 15px auto;
                padding: 15px;
            }
            
            .ai-stat-box {
                min-width: 100px;
                padding: 10px;
            }
            
            .ai-stat-value {
                font-size: 1.5em;
            }
            
            .insight-tab {
                padding: 8px 12px;
                font-size: 12px;
                margin-right: 2px;
            }
            
            .ai-prediction {
                font-size: 14px;
                padding: 10px;
            }
            
            .risk-assessment, .safety-measures {
                padding: 10px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px 5px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            p {
                font-size: 0.9em;
            }
            
            #controls {
                grid-template-columns: 1fr;
            }
            
            button {
                font-size: 13px;
                padding: 10px;
            }
            
            #earthquakeData, #aiFeedback, #statsView, #earthquakeMap {
                padding: 10px;
                height: 350px;
                margin: 10px auto;
            }
            
            .ai-stat-box {
                min-width: calc(50% - 5px);
                padding: 8px;
            }
            
            .trend-graph {
                height: 120px;
            }
            
            .ai-header {
                margin-bottom: 10px;
                padding-bottom: 8px;
            }
            
            .ai-icon {
                width: 25px;
                height: 25px;
                min-width: 25px;
            }
            
            #earthquakeData h2, #statsView h2, #aiFeedback h2 {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <img src="0.jpg" id="logo" alt="Earthquake Analyst Logo">
    <h1>Earthquake Analyst</h1>
    <p>Real-time seismic data, maps, and AI insights at your fingertips.</p>

    <div id="controls">
        <button id="fetchDataBtn" onclick="fetchData()">Fetch Data</button>
        <button onclick="viewRegularEarthquakes()">Regular Quakes</button>
        <button onclick="viewDangerousEarthquakes()">Dangerous Quakes</button>
        <button onclick="viewStats()">View Stats</button>
        <button id="mapToggleBtn" onclick="toggleMap()">Show Map</button>
    </div>

    <div id="earthquakeData"><h2>Seismic Feed</h2><p>No data available yet. Tap "Fetch Data" to start.</p></div>
    <div id="earthquakeMap"></div>
    <div id="statsView" style="display: none;">
        <h2>Earthquake Stats</h2>
        <input type="date" id="statsDatePicker" onchange="updateStats()">
        <div id="statsContent">No data recorded yet.</div>
    </div>
    <div id="aiFeedback">
        <h2>AI Insights</h2>
    </div>

    <footer>
        <p></p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        let earthquakeData = [];
        let dangerousEarthquakes = [];
        let stats = {};
        let currentMapData = [];
        let map = null; // Initialize map as null first
        const aiInsights = [
            {
                prediction: "Severe seismic activity detected in Pacific region",
                riskAssessment: ["Major structural risks to buildings in affected areas", "High probability of aftershocks within 48 hours", "Potential tsunami risk for coastal regions"],
                safetyMeasures: ["Evacuate to higher ground if near coastline", "Take cover under solid furniture away from windows", "Prepare emergency supplies and communication plans"],
                regionalAnalysis: {
                    "Ring of Fire": "Unusually active with 85% increase in seismic events",
                    "Southern Alaska": "Significant tremor clusters forming",
                    "Cascadia Subduction Zone": "Showing concerning pressure buildup"
                },
                faultLines: ["San Andreas Fault", "Cascadia Subduction Zone", "Aleutian Trench"],
                trendKeywords: ["increasing", "concerning", "major"],
                stats: {
                    avgMagnitude: "6.2",
                    recentEvents: "7",
                    riskLevel: "High",
                    affectedRadius: "120 km"
                }
            },
            {
                prediction: "Moderate earthquake cluster forming along fault line",
                riskAssessment: ["Minor structural damage possible in older buildings", "Aftershocks expected but diminishing in intensity", "Localized infrastructure disruption"],
                safetyMeasures: ["Secure heavy furniture and fixtures to walls", "Check gas and water lines for damage", "Stay informed through official emergency channels"],
                regionalAnalysis: {
                    "Central California": "Multiple small events indicating pressure release",
                    "Pacific Northwest": "Typical activity levels within expected ranges",
                    "Gulf of Alaska": "Minor tremor series consistent with seasonal patterns"
                },
                faultLines: ["Queen Charlotte Fault", "Denali Fault System", "Fairweather Fault"],
                trendKeywords: ["stable", "monitored", "moderate"],
                stats: {
                    avgMagnitude: "4.7",
                    recentEvents: "12",
                    riskLevel: "Moderate",
                    affectedRadius: "65 km"
                }
            },
            {
                prediction: "Low-intensity tremors detected with minimal impact",
                riskAssessment: ["Negligible structural risk to modern buildings", "Isolated events with low probability of escalation", "Limited to geological monitoring significance"],
                safetyMeasures: ["Continue normal activities with awareness", "No immediate action required", "Consider checking emergency preparedness plans"],
                regionalAnalysis: {
                    "Eastern United States": "Typical low-level background activity",
                    "New Madrid Seismic Zone": "Minimal activity within normal parameters",
                    "Great Basin Region": "Scattered minor events consistent with historical patterns"
                },
                faultLines: ["Ramapo Fault", "Wasatch Fault", "Eastern Tennessee Seismic Zone"],
                trendKeywords: ["stable", "minimal", "expected"],
                stats: {
                    avgMagnitude: "2.8",
                    recentEvents: "23",
                    riskLevel: "Low",
                    affectedRadius: "15 km"
                }
            }
        ];

        // Initialize map only after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            // Set consistent sizes for elements on load
            setConsistentSizes();
            // Add listener for orientation changes
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    setConsistentSizes();
                    if (map) map.invalidateSize();
                }, 200);
            });
        });

        function setConsistentSizes() {
            // Set fixed heights for containers
            const containers = [
                document.getElementById('earthquakeData'),
                document.getElementById('statsView'),
                document.getElementById('aiFeedback'),
                document.getElementById('earthquakeMap')
            ];
            
            containers.forEach(container => {
                if (container) {
                    container.style.height = '350px';
                }
            });
        }

        function initMap() {
            // Only initialize if not already created
            if (!map) {
                map = L.map('earthquakeMap', {
                    zoomControl: true,
                    doubleClickZoom: false,
                    scrollWheelZoom: true,
                    dragging: !L.Browser.mobile,
                    tap: !L.Browser.mobile
                }).setView([0, 0], 2);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap contributors',
                    tileSize: 512,
                    zoomOffset: -1
                }).addTo(map);
                
                // Add legend to map
                const legend = L.control({position: 'bottomright'});
                legend.onAdd = function(map) {
                    const div = L.DomUtil.create('div', 'info legend');
                    div.style.background = 'rgba(42, 64, 102, 0.8)';
                    div.style.padding = '10px';
                    div.style.borderRadius = '8px';
                    div.style.color = '#d9e4ff';
                    div.style.fontFamily = "'Exo 2', sans-serif";
                    
                    div.innerHTML = `
                        <div style="margin-bottom:8px;font-weight:bold;">Magnitude</div>
                        <div style="display:flex;align-items:center;margin-bottom:5px;">
                            <div style="width:15px;height:15px;border-radius:50%;background:#00c6ff;margin-right:8px;"></div>
                            <span>< 4.0</span>
                        </div>
                        <div style="display:flex;align-items:center;">
                            <div style="width:15px;height:15px;border-radius:50%;background:#ff5e62;margin-right:8px;"></div>
                            <span>≥ 4.0</span>
                        </div>
                    `;
                    return div;
                };
                legend.addTo(map);
            }
        }

        function fetchData() {
            // Show loading state with spinner
            document.getElementById("earthquakeData").innerHTML = `
                <h2>Seismic Feed</h2>
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p>Loading earthquake data...</p>
                </div>
            `;
            
            fetch("https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson")
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    if (data && data.features && data.features.length > 0) {
                        // Ensure data processing is consistent
                        earthquakeData = data.features;
                        currentMapData = earthquakeData;
                        processEarthquakeData();
                        
                        // Always initialize map data, even if map is not visible
                        if (!map) initMap();
                        
                        // Only update visible map
                        if (document.getElementById("earthquakeMap").style.display === "block") {
                            updateMap();
                        }
                        
                        generateAIAnalysis();
                        storeDataForStats();
                    } else {
                        document.getElementById("earthquakeData").innerHTML = `<h2>Seismic Feed</h2><p>No earthquake data available at this time. Please try again later.</p>`;
                    }
                })
                .catch(error => {
                    document.getElementById("earthquakeData").innerHTML = `<h2>Error</h2><p>Error: ${error.message}</p><p>Please check your connection and try again.</p>`;
                    console.error("Fetch error:", error);
                });
        }

        function processEarthquakeData() {
            const container = document.getElementById("earthquakeData");
            container.innerHTML = `<h2>Seismic Feed (Updated: ${new Date().toLocaleString()})</h2>`;
            earthquakeData.forEach(quake => {
                const { place, mag, time } = quake.properties;
                const date = new Date(time).toLocaleString();
                container.innerHTML += `
                    <div>
                        <strong>Location:</strong> ${place}<br>
                        <strong>Magnitude:</strong> ${mag.toFixed(1)}<br>
                        <strong>Time:</strong> ${date}<hr>
                    </div>`;
            });
        }

        function storeDataForStats() {
            const currentDate = new Date().toLocaleDateString("en-US", { timeZone: "UTC" });
            stats[currentDate] = earthquakeData;
        }

        function viewRegularEarthquakes() {
            if (earthquakeData && earthquakeData.length) {
                processEarthquakeData();
                currentMapData = earthquakeData;
                if (document.getElementById("earthquakeMap").style.display === "block") updateMap();
            } else {
                document.getElementById("earthquakeData").innerHTML = "<h2>Regular Quakes</h2><p>No data yet. Tap 'Fetch Data' to load earthquake information.</p>";
            }
            document.getElementById("statsView").style.display = "none";
        }

        function viewDangerousEarthquakes() {
            const container = document.getElementById("earthquakeData");
            container.innerHTML = "<h2>High-Impact Quakes (Mag ≥ 4.0)</h2>";
            if (earthquakeData && earthquakeData.length) {
                dangerousEarthquakes = earthquakeData.filter(e => e.properties.mag >= 4.0);
                if (dangerousEarthquakes.length) {
                    dangerousEarthquakes.forEach(quake => {
                        const { place, mag, time } = quake.properties;
                        const date = new Date(time).toLocaleString();
                        container.innerHTML += `
                            <div class="dangerous">
                                <strong>Location:</strong> ${place}<br>
                                <strong>Magnitude:</strong> ${mag.toFixed(1)}<br>
                                <strong>Time:</strong> ${date}<hr>
                            </div>`;
                    });
                    currentMapData = dangerousEarthquakes;
                    if (document.getElementById("earthquakeMap").style.display === "block") updateMap();
                } else {
                    container.innerHTML += "<p>No high-impact quakes found.</p>";
                    currentMapData = [];
                    if (document.getElementById("earthquakeMap").style.display === "block") updateMap();
                }
            } else {
                container.innerHTML += "<p>No data yet. Tap 'Fetch Data' to load earthquake information.</p>";
            }
            document.getElementById("statsView").style.display = "none";
        }

        function viewStats() {
            const statsView = document.getElementById("statsView");
            if (statsView.style.display === "block") {
                statsView.style.display = "none";
            } else {
                statsView.style.display = "block";
                const datePicker = document.getElementById("statsDatePicker");
                datePicker.value = new Date().toISOString().split("T")[0];
                updateStats();
            }
        }

        function updateStats() {
            const statsContent = document.getElementById("statsContent");
            const selectedDate = new Date(document.getElementById("statsDatePicker").value)
                .toLocaleDateString("en-US", { timeZone: "UTC" });
            statsContent.innerHTML = `<h3>Stats for ${selectedDate}</h3>`;
            if (stats[selectedDate] && stats[selectedDate].length) {
                statsContent.innerHTML += `<p><strong>Total Quakes:</strong> ${stats[selectedDate].length}</p>`;
                stats[selectedDate].forEach(quake => {
                    const { place, mag, time } = quake.properties;
                    const date = new Date(time).toLocaleString();
                    statsContent.innerHTML += `
                        <div>
                            <strong>Location:</strong> ${place}<br>
                            <strong>Magnitude:</strong> ${mag.toFixed(1)}<br>
                            <strong>Time:</strong> ${date}
                        </div>`;
                });
            } else {
                statsContent.innerHTML += "<p>No data for this date. Tap 'Fetch Data' to load.</p>";
            }
        }

        function generateAIAnalysis() {
            const aiSection = document.getElementById("aiFeedback");
            aiSection.style.display = "block";
            let currentIndex = 0;
            
            // Generate historical trend data
            function generateTrendData(baseValue, dataPoints, trendType) {
                const trend = [];
                let currentValue = baseValue;
                
                for (let i = 0; i < dataPoints; i++) {
                    let change;
                    switch (trendType) {
                        case 'increasing':
                            // Increasing trend
                            change = Math.random() * 0.8 - 0.1; // mostly positive changes
                            break;
                        case 'decreasing':
                            // Decreasing trend
                            change = Math.random() * 0.8 - 0.7; // mostly negative changes
                            break;
                        case 'stable':
                        default:
                            // Stable with small variations
                            change = Math.random() * 0.6 - 0.3; // variations around zero
                    }
                    
                    currentValue = Math.max(0.5, currentValue + change); // ensure value doesn't go below 0.5
                    trend.push(parseFloat(currentValue.toFixed(1)));
                }
                
                return trend;
            }
            
            // Get geographical hotspots from earthquake data
            function getHotspots() {
                if (!earthquakeData || earthquakeData.length === 0) {
                    return [];
                }
                
                const regions = {};
                
                // Group earthquakes by rough geographical regions
                earthquakeData.forEach(quake => {
                    const place = quake.properties.place;
                    const mag = quake.properties.mag;
                    
                    let region = "Other";
                    
                    // Extract region from place string
                    if (place.includes("Alaska")) region = "Alaska";
                    else if (place.includes("California")) region = "California";
                    else if (place.includes("Hawaii")) region = "Hawaii";
                    else if (place.includes("Washington") || place.includes("Oregon")) region = "Pacific Northwest";
                    else if (place.includes("Mexico")) region = "Mexico";
                    else if (place.includes("Japan")) region = "Japan";
                    else if (place.includes("Indonesia")) region = "Indonesia";
                    else if (place.includes("Chile")) region = "Chile";
                    
                    // Add to region count and sum magnitudes
                    if (!regions[region]) {
                        regions[region] = { count: 0, totalMag: 0, avgMag: 0 };
                    }
                    
                    regions[region].count++;
                    regions[region].totalMag += mag;
                    regions[region].avgMag = regions[region].totalMag / regions[region].count;
                });
                
                // Convert to array and sort by count
                return Object.entries(regions)
                    .map(([name, data]) => ({ 
                        name, 
                        count: data.count, 
                        avgMag: data.avgMag.toFixed(1)
                    }))
                    .filter(r => r.name !== "Other" && r.count > 1) // Only include named regions with multiple quakes
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 3); // Top 3 regions
            }
            
            // Calculate some realistic values based on actual earthquake data
            function getAIInsightWithRealData() {
                const insight = {...aiInsights[currentIndex]};
                
                if (earthquakeData && earthquakeData.length > 0) {
                    // Calculate real statistics
                    const magnitudes = earthquakeData.map(q => q.properties.mag);
                    const avgMag = magnitudes.reduce((sum, mag) => sum + mag, 0) / magnitudes.length;
                    
                    // Count events in last 24 hours
                    const last24Hours = Date.now() - (24 * 60 * 60 * 1000);
                    const recentCount = earthquakeData.filter(q => q.properties.time > last24Hours).length;
                    
                    // Count dangerous quakes
                    const dangerousCount = earthquakeData.filter(q => q.properties.mag >= 4.5).length;
                    
                    // Calculate max magnitude
                    const maxMagnitude = Math.max(...magnitudes);
                    
                    // Determine trend type based on data
                    let trendType = 'stable';
                    if (dangerousCount > 3 || maxMagnitude > 6.0) {
                        trendType = 'increasing';
                    } else if (avgMag < 2.5 && dangerousCount === 0) {
                        trendType = 'decreasing';
                    }
                    
                    // Determine risk level
                    let riskLevel = "Low";
                    if (avgMag > 5.0 || dangerousCount >= 3) {
                        riskLevel = "High";
                    } else if (avgMag > 3.5 || dangerousCount >= 1) {
                        riskLevel = "Moderate";
                    }
                    
                    // Update insight with real data
                    insight.stats = {
                        avgMagnitude: avgMag.toFixed(1),
                        recentEvents: recentCount.toString(),
                        riskLevel: riskLevel,
                        affectedRadius: Math.round(avgMag * avgMag * 5) + " km",
                        maxMagnitude: maxMagnitude.toFixed(1),
                        dangerousCount: dangerousCount.toString()
                    };
                    
                    // Generate trend data
                    insight.trends = {
                        magnitude: generateTrendData(avgMag, 7, trendType),
                        events: Array.from({length: 7}, (_, i) => 
                            Math.max(1, Math.round(recentCount / 3 + (Math.random() * recentCount / 2 - recentCount / 4)))
                        )
                    };
                    
                    // Get geographical hotspots
                    insight.hotspots = getHotspots();
                    
                    // Customize prediction based on data
                    if (riskLevel === "High") {
                        insight.prediction = `Major seismic activity detected with max magnitude of ${maxMagnitude.toFixed(1)}`;
                        insight.trendKeywords = ["increasing", "concerning", "major"];
                    } else if (riskLevel === "Moderate") {
                        insight.prediction = `Moderate earthquake activity with ${recentCount} events in last 24hrs`;
                        insight.trendKeywords = ["stable", "monitored", "moderate"];
                    } else {
                        insight.prediction = `Minor seismic activity observed with average magnitude of ${avgMag.toFixed(1)}`;
                        insight.trendKeywords = ["stable", "minimal", "expected"];
                    }
                }
                
                return insight;
            }
            
            function updateAIInsight() {
                const insight = getAIInsightWithRealData();
                
                // Create tab navigation with better display on small screens
                const tabsHtml = `
                    <div class="ai-header">
                        <div class="ai-icon"></div>
                        <h2>AI Insights & Analysis</h2>
                    </div>
                    
                    <div class="ai-prediction">${insight.prediction}</div>
                    
                    <div style="display: flex; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch;">
                        <button class="insight-tab active" data-tab="overview">Overview</button>
                        <button class="insight-tab" data-tab="trends">Trends</button>
                        <button class="insight-tab" data-tab="regional">Regional</button>
                    </div>
                `;
                
                // Create overview tab content with consistent sizing
                const overviewHtml = `
                    <div id="overview-content" class="insight-content active">
                        <div class="ai-stats">
                            <div class="ai-stat-box">
                                <div class="ai-stat-value">${insight.stats.avgMagnitude}</div>
                                <div class="ai-stat-label">Avg Magnitude</div>
                            </div>
                            <div class="ai-stat-box">
                                <div class="ai-stat-value">${insight.stats.recentEvents}</div>
                                <div class="ai-stat-label">Recent Events</div>
                            </div>
                            <div class="ai-stat-box">
                                <div class="ai-stat-value">${insight.stats.riskLevel}</div>
                                <div class="ai-stat-label">Risk Level</div>
                            </div>
                            <div class="ai-stat-box">
                                <div class="ai-stat-value">${insight.stats.maxMagnitude || "N/A"}</div>
                                <div class="ai-stat-label">Max Magnitude</div>
                            </div>
                        </div>
                        
                        <div class="risk-assessment">
                            <strong>Risk Assessment:</strong><br>
                            ${insight.riskAssessment.map(item => `• ${item}`).join("<br>")}
                        </div>
                        
                        <div class="safety-measures">
                            <strong>Safety Measures:</strong><br>
                            ${insight.safetyMeasures.map(item => `• ${item}`).join("<br>")}
                        </div>
                    </div>
                `;
                
                // Create trends tab content with fixed scales
                let trendsHtml = `<div id="trends-content" class="insight-content">`;
                
                if (insight.trends) {
                    // Add magnitude trend graph with consistent scaling
                    trendsHtml += `
                        <div class="trend-graph-title">Magnitude Trend (Last 7 Days)</div>
                        <div class="trend-graph">
                            <div class="trend-axis">
                                <div class="trend-axis-label">8</div>
                                <div class="trend-axis-label">6</div>
                                <div class="trend-axis-label">4</div>
                                <div class="trend-axis-label">2</div>
                                <div class="trend-axis-label">0</div>
                            </div>
                            ${insight.trends.magnitude.map((mag, i) => {
                                const height = Math.min(100, (mag / 8) * 100); // Scale to percentage with a maximum
                                const day = 6 - i; // Days ago (0 is today)
                                const isDanger = mag >= 4.0;
                                
                                return `
                                    <div class="trend-graph-bar ${isDanger ? 'danger' : ''}" 
                                         style="height: ${height}%">
                                        <div class="trend-graph-label">${day === 0 ? 'Today' : (day === 1 ? 'Yesterday' : `${day}d ago`)}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="trend-graph-title">Event Frequency (Last 7 Days)</div>
                        <div class="trend-graph">
                            <div class="trend-axis">
                                <div class="trend-axis-label">25</div>
                                <div class="trend-axis-label">20</div>
                                <div class="trend-axis-label">15</div>
                                <div class="trend-axis-label">10</div>
                                <div class="trend-axis-label">5</div>
                                <div class="trend-axis-label">0</div>
                            </div>
                            ${insight.trends.events.map((count, i) => {
                                const height = Math.min(100, (count / 25) * 100); // Scale to percentage with a maximum
                                const day = 6 - i; // Days ago (0 is today)
                                
                                return `
                                    <div class="trend-graph-bar" 
                                         style="height: ${height}%">
                                        <div class="trend-graph-label">${day === 0 ? 'Today' : (day === 1 ? 'Yesterday' : `${day}d ago`)}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="padding: 10px; text-align: center; margin-top: 20px;">
                            <div class="ai-badge">${insight.trendKeywords[0]}</div>
                            <div class="ai-badge">${insight.trendKeywords[1]}</div>
                            <div class="ai-badge">${insight.trendKeywords[2]}</div>
                        </div>
                    `;
                } else {
                    trendsHtml += `<p>No trend data available. Please fetch earthquake data to see trends.</p>`;
                }
                
                trendsHtml += `</div>`;
                
                // Create regional tab content with consistent layout
                let regionalHtml = `<div id="regional-content" class="insight-content">`;
                
                if (insight.hotspots && insight.hotspots.length > 0) {
                    // Show hotspots from actual data
                    regionalHtml += `
                        <div class="regional-insight">
                            <h3>Active Hotspots</h3>
                            ${insight.hotspots.map(region => `
                                <div style="margin-bottom: 10px;">
                                    <strong>${region.name}</strong>: ${region.count} events, Avg Mag: ${region.avgMag}
                                    ${parseFloat(region.avgMag) >= 4.0 ? '<span class="ai-badge warning">High Activity</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else if (insight.regionalAnalysis) {
                    // Show pre-defined regional analysis
                    regionalHtml += `
                        <div class="regional-insight">
                            <h3>Regional Analysis</h3>
                            ${Object.entries(insight.regionalAnalysis).map(([region, analysis]) => `
                                <div style="margin-bottom: 10px;"><strong>${region}</strong>: ${analysis}</div>
                            `).join('')}
                        </div>
                    `;
                }
                
                if (insight.faultLines && insight.faultLines.length > 0) {
                    regionalHtml += `
                        <div class="regional-insight" style="margin-top: 15px;">
                            <h3>Active Fault Systems</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;">
                                ${insight.faultLines.map(fault => `
                                    <div class="ai-badge">${fault}</div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                regionalHtml += `</div>`;
                
                // Combine all content
                aiSection.innerHTML = tabsHtml + overviewHtml + trendsHtml + regionalHtml;
                
                // Add tab switching functionality with touch support
                setTimeout(() => {
                    const tabs = document.querySelectorAll('.insight-tab');
                    const tabHandler = function() {
                        // Hide all content sections
                        document.querySelectorAll('.insight-content').forEach(content => {
                            content.classList.remove('active');
                        });
                        
                        // Show selected content
                        const contentId = this.getAttribute('data-tab') + '-content';
                        document.getElementById(contentId).classList.add('active');
                        
                        // Update active tab styling
                        tabs.forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                    };
                    
                    tabs.forEach(tab => {
                        tab.addEventListener('click', tabHandler);
                        tab.addEventListener('touchend', function(e) {
                            e.preventDefault();
                            tabHandler.call(this);
                        });
                    });
                }, 100);
                
                // Update the index for next insight
                currentIndex = (currentIndex + 1) % aiInsights.length;
            }
            
            updateAIInsight();
            clearInterval(window.aiCycleInterval);
            window.aiCycleInterval = setInterval(updateAIInsight, 12000); // Longer display time for more complex insights
        }

        function updateMap() {
            if (!map) {
                initMap(); // Make sure map is initialized
                return; // Return and let the map initialize first
            }
            
            // Clear previous markers
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) map.removeLayer(layer);
            });
            
            // Remove any existing overlay message
            const existingOverlay = document.getElementById("mapOverlayMessage");
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            if (currentMapData && currentMapData.length) {
                const markers = currentMapData.map(quake => {
                    const coords = quake.geometry.coordinates; // [lon, lat, depth]
                    const { place, mag } = quake.properties;
                    const markerSize = Math.max(10, mag * 5);
                    const marker = L.marker([coords[1], coords[0]], {
                        title: `${place} (Mag: ${mag.toFixed(1)})`
                    }).addTo(map);
                    marker.bindPopup(`<b>${place}</b><br>Magnitude: ${mag.toFixed(1)}<br>Coords: ${coords[1].toFixed(4)}°N, ${coords[0].toFixed(4)}°E`);
                    marker.setIcon(L.divIcon({
                        className: 'earthquake-marker',
                        html: `<div style="background: linear-gradient(45deg, #ff5e62, #00c6ff); width: ${markerSize}px; height: ${markerSize}px; border-radius: 50%; opacity: 0.8; border: 2px solid #fff;"></div>`,
                        iconSize: [markerSize, markerSize]
                    }));
                    return marker;
                });
                
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                    map.invalidateSize();
                    markers[0]?.openPopup();
                }
            } else {
                map.setView([0, 0], 2);
                
                // Add a message overlay without destroying map
                if (!document.getElementById("mapOverlayMessage")) {
                    const overlay = document.createElement("div");
                    overlay.id = "mapOverlayMessage";
                    overlay.style.cssText = "position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(42, 64, 102, 0.8); padding: 15px; border-radius: 10px; color: #d9e4ff; text-align: center; z-index: 1000;";
                    overlay.innerHTML = "No earthquake data to display.<br>Please tap the \"Fetch Data\" button to load data.";
                    document.getElementById("earthquakeMap").appendChild(overlay);
                }
            }
        }

        function toggleMap() {
            const mapDiv = document.getElementById("earthquakeMap");
            const mapBtn = document.getElementById("mapToggleBtn");
            
            if (mapDiv.style.display === "block") {
                mapDiv.style.display = "none";
                mapBtn.textContent = "Show Map";
            } else {
                mapDiv.style.display = "block";
                mapBtn.textContent = "Hide Map";
                
                // Show loading message while map initializes
                if (!document.getElementById("mapLoadingMessage")) {
                    const loadingOverlay = document.createElement("div");
                    loadingOverlay.id = "mapLoadingMessage";
                    loadingOverlay.style.cssText = "position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(42, 64, 102, 0.8); padding: 15px; border-radius: 10px; color: #d9e4ff; text-align: center; z-index: 1000;";
                    loadingOverlay.innerHTML = `
                        <div class="loading-spinner" style="width: 30px; height: 30px; border-width: 3px;"></div>
                        <p>Loading map...</p>
                    `;
                    mapDiv.appendChild(loadingOverlay);
                }
                
                // Ensure map is loaded and properly sized
                setTimeout(() => {
                    // Make sure map is initialized
                    if (!map) initMap();
                    
                    // Remove loading message
                    const loadingMsg = document.getElementById("mapLoadingMessage");
                    if (loadingMsg) loadingMsg.remove();
                    
                    // Force map to resize and update
                    map.invalidateSize(true);
                    updateMap();
                }, 500); // Longer delay to ensure map loads properly
            }
        }

        // Add resize handler with throttling
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                setConsistentSizes();
                if (document.getElementById("earthquakeMap").style.display === "block" && map) {
                    map.invalidateSize(true);
                }
            }, 250);
        });
    </script>
</body>
</html>
